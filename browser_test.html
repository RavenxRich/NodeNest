<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeNest Folder Persistence Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-title {
            color: #00ccff;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .success {
            background: #1a4a1a;
            border-left: 4px solid #00ff00;
        }
        .error {
            background: #4a1a1a;
            border-left: 4px solid #ff0000;
        }
        .warning {
            background: #4a4a1a;
            border-left: 4px solid #ffaa00;
        }
        .info {
            background: #1a1a4a;
            border-left: 4px solid #0088ff;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0088ff;
        }
        .code {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª NodeNest Folder Persistence Test</h1>
        <p>This test diagnoses the folder persistence issue described in the review request.</p>
        
        <div class="test-section">
            <div class="test-title">ğŸ® Test Controls</div>
            <button onclick="runAllTests()">ğŸš€ Run All Tests</button>
            <button onclick="clearAllData()">ğŸ—‘ï¸ Clear All Data</button>
            <button onclick="simulateFirstTimeSetup()">ğŸ†• Simulate First Time</button>
            <button onclick="openNodeNest()">ğŸ”— Open NodeNest</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const FRONTEND_URL = 'https://tool-orbit.preview.emergentagent.com';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testBrowserSupport() {
            log('<div class="test-title">ğŸŒ Browser Support Test</div>');
            
            const hasFileSystemAPI = 'showDirectoryPicker' in window;
            const isInIframe = window.self !== window.top;
            const userAgent = navigator.userAgent;
            
            log(`ğŸ”§ File System Access API: ${hasFileSystemAPI ? 'âœ… Supported' : 'âŒ Not supported'}`, hasFileSystemAPI ? 'success' : 'error');
            log(`ğŸ–¼ï¸ Running in iframe: ${isInIframe ? 'âŒ Yes (problematic)' : 'âœ… No (good)'}`, isInIframe ? 'error' : 'success');
            log(`ğŸŒ User Agent: ${userAgent}`, 'info');
            
            if (!hasFileSystemAPI) {
                log('ğŸ’¡ Solution: Use Chrome, Edge, or Brave browser', 'warning');
            }
            
            if (isInIframe) {
                log('ğŸ’¡ Solution: Open app in new tab (right-click â†’ "Open in New Tab")', 'warning');
            }
            
            return { hasFileSystemAPI, isInIframe, userAgent };
        }

        async function testLocalStorageState() {
            log('<div class="test-title">ğŸ“‹ LocalStorage State Test</div>');
            
            const hasDirectory = localStorage.getItem('nodenest_has_directory');
            const storageMode = localStorage.getItem('nodenest_storage_mode');
            const localStorageType = localStorage.getItem('nodenest_local_storage_type');
            const userId = localStorage.getItem('nodenest_user_id');
            
            log(`ğŸ“ nodenest_has_directory: "${hasDirectory}"`, hasDirectory === 'true' ? 'success' : 'info');
            log(`ğŸ’¾ nodenest_storage_mode: "${storageMode}"`, storageMode === 'local' ? 'success' : 'info');
            log(`ğŸ”§ nodenest_local_storage_type: "${localStorageType}"`, localStorageType === 'filesystem' ? 'success' : 'info');
            log(`ğŸ‘¤ nodenest_user_id: "${userId}"`, userId ? 'success' : 'info');
            
            return { hasDirectory, storageMode, localStorageType, userId };
        }

        async function testIndexedDBState() {
            log('<div class="test-title">ğŸ—„ï¸ IndexedDB State Test</div>');
            
            try {
                // Open IndexedDB
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('NodeNestDB', 1);
                    request.onerror = () => {
                        log(`âŒ Failed to open IndexedDB: ${request.error}`, 'error');
                        reject(request.error);
                    };
                    request.onsuccess = () => {
                        log('âœ… IndexedDB opened successfully', 'success');
                        resolve(request.result);
                    };
                    request.onupgradeneeded = (event) => {
                        log('ğŸ”§ IndexedDB upgrade needed - creating handles store', 'info');
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('handles')) {
                            db.createObjectStore('handles');
                        }
                    };
                });
                
                // Check for directory handle
                const tx = db.transaction('handles', 'readonly');
                const store = tx.objectStore('handles');
                const request = store.get('directory');
                
                const handle = await new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        log('âœ… IndexedDB query successful', 'success');
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        log(`âŒ IndexedDB query failed: ${request.error}`, 'error');
                        reject(request.error);
                    };
                });
                
                if (handle) {
                    log(`âœ… Found directory handle: "${handle.name}"`, 'success');
                    log(`ğŸ“‚ Handle type: ${handle.kind}`, 'info');
                    
                    // Test permission status
                    try {
                        const permission = await handle.queryPermission({ mode: 'readwrite' });
                        log(`ğŸ” Permission status: "${permission}"`, permission === 'granted' ? 'success' : 'warning');
                        
                        if (permission === 'granted') {
                            log('âœ… Permission already granted - should auto-navigate to dashboard', 'success');
                        } else if (permission === 'prompt') {
                            log('âš ï¸ Permission needs to be requested - browser should show dialog', 'warning');
                        } else {
                            log('âŒ Permission denied - user will need to select folder again', 'error');
                        }
                        
                        return {
                            hasHandle: true,
                            handleName: handle.name,
                            permission,
                            handle
                        };
                    } catch (permError) {
                        log(`âŒ Error checking permission: ${permError.message}`, 'error');
                        return {
                            hasHandle: true,
                            handleName: handle.name,
                            permission: 'error',
                            error: permError.message
                        };
                    }
                } else {
                    log('âŒ No directory handle found in IndexedDB', 'error');
                    return { hasHandle: false };
                }
                
            } catch (error) {
                log(`âŒ IndexedDB test failed: ${error.message}`, 'error');
                return { hasHandle: false, error: error.message };
            }
        }

        async function testLandingPageLogic() {
            log('<div class="test-title">ğŸ  Landing Page Logic Analysis</div>');
            
            const localStorageState = await testLocalStorageState();
            const indexedDBState = await testIndexedDBState();
            
            // Analyze the Landing.js logic (line 52)
            const storageMode = localStorageState.storageMode;
            const hasDirectory = localStorageState.hasDirectory === 'true';
            
            log(`ğŸ“Š Current storageMode: "${storageMode}"`, 'info');
            log(`ğŸ“ hasDirectory flag: ${hasDirectory}`, 'info');
            
            // Check the condition: storageMode === 'local' || (!storageMode && hasDirectory === 'true')
            const shouldCheckFolder = storageMode === 'local' || (!storageMode && hasDirectory);
            log(`ğŸ¯ Should check folder: ${shouldCheckFolder}`, shouldCheckFolder ? 'success' : 'warning');
            
            if (shouldCheckFolder) {
                log('âœ… Landing page SHOULD attempt folder restoration', 'success');
                
                if (indexedDBState.hasHandle) {
                    log('âœ… IndexedDB has folder handle', 'success');
                    
                    if (indexedDBState.permission === 'granted') {
                        log('ğŸ¯ EXPECTED BEHAVIOR: Auto-navigate to dashboard (no folder picker)', 'success');
                    } else if (indexedDBState.permission === 'prompt') {
                        log('ğŸ¯ EXPECTED BEHAVIOR: Show permission dialog, then navigate to dashboard', 'warning');
                    } else {
                        log('ğŸ¯ EXPECTED BEHAVIOR: Clear state and show folder picker', 'error');
                    }
                } else {
                    log('âŒ No folder handle - will show folder picker', 'error');
                }
            } else {
                log('âŒ Landing page will NOT attempt folder restoration', 'error');
                log('ğŸ¯ EXPECTED BEHAVIOR: Show storage options (Get Started)', 'info');
            }
            
            return { shouldCheckFolder, localStorageState, indexedDBState };
        }

        async function runAllTests() {
            clearResults();
            log('<h2>ğŸ§ª NodeNest Folder Persistence Diagnostic</h2>');
            log(`<p>Testing folder persistence for: <strong>${FRONTEND_URL}</strong></p>`);
            
            const browserSupport = await testBrowserSupport();
            const landingLogic = await testLandingPageLogic();
            
            // Generate diagnosis
            log('<div class="test-title">ğŸ” Diagnosis & Recommendations</div>');
            
            if (!browserSupport.hasFileSystemAPI) {
                log('ğŸ”´ ISSUE: Browser does not support File System Access API', 'error');
                log('ğŸ’¡ SOLUTION: Use Chrome, Edge, or Brave browser', 'warning');
            } else if (browserSupport.isInIframe) {
                log('ğŸ”´ ISSUE: Running in iframe prevents folder access', 'error');
                log('ğŸ’¡ SOLUTION: Open app in new tab', 'warning');
            } else if (!landingLogic.localStorageState.hasDirectory) {
                log('ğŸ”´ ISSUE: No hasDirectory flag in localStorage', 'error');
                log('ğŸ’¡ CAUSE: User never successfully selected a folder', 'info');
            } else if (!landingLogic.indexedDBState.hasHandle) {
                log('ğŸ”´ ISSUE: No folder handle stored in IndexedDB', 'error');
                log('ğŸ’¡ CAUSE: Folder handle was not saved or was cleared', 'info');
            } else if (landingLogic.indexedDBState.permission === 'denied') {
                log('ğŸ”´ ISSUE: Folder permission was denied', 'error');
                log('ğŸ’¡ CAUSE: User denied permission or browser blocked access', 'info');
            } else if (landingLogic.indexedDBState.permission === 'prompt') {
                log('ğŸŸ¡ ISSUE: Permission needs to be requested', 'warning');
                log('ğŸ’¡ CAUSE: Browser requires fresh permission request', 'info');
            } else if (!landingLogic.shouldCheckFolder) {
                log('ğŸ”´ ISSUE: Landing page logic not triggering folder check', 'error');
                log('ğŸ’¡ CAUSE: Storage mode or hasDirectory flag incorrect', 'info');
            } else {
                log('ğŸŸ¢ All checks passed - folder persistence should work', 'success');
                log('ğŸ’¡ If still not working, check browser console for errors', 'info');
            }
            
            // Code inspection recommendations
            log('<div class="test-title">ğŸ”§ Code Inspection Points</div>');
            log('ğŸ“ Check Landing.js lines 32-116 (checkExistingStorage function)', 'info');
            log('ğŸ—„ï¸ Check StorageContext.js lines 56-115 (folder handle storage)', 'info');
            log('ğŸ” Look for console messages starting with ğŸ“, âœ…, âŒ, ğŸ“, ğŸ”„', 'info');
        }

        function clearAllData() {
            log('<div class="test-title">ğŸ—‘ï¸ Clearing All Data</div>');
            
            // Clear localStorage
            const keys = ['nodenest_has_directory', 'nodenest_storage_mode', 'nodenest_local_storage_type', 'nodenest_user_id'];
            keys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    log(`ğŸ—‘ï¸ Removed localStorage: ${key}`, 'info');
                }
            });
            
            // Clear IndexedDB
            indexedDB.deleteDatabase('NodeNestDB').onsuccess = () => {
                log('ğŸ—‘ï¸ Cleared IndexedDB: NodeNestDB', 'info');
            };
            
            log('âœ… All data cleared - refresh page to test first-time setup', 'success');
        }

        function simulateFirstTimeSetup() {
            clearAllData();
            setTimeout(() => {
                log('<div class="test-title">ğŸ†• Simulating First Time Setup</div>');
                log('âœ… Data cleared - now open NodeNest to test first-time folder selection', 'success');
                log('ğŸ¯ Expected: Should show "Get Started" button and storage options', 'info');
            }, 1000);
        }

        function openNodeNest() {
            log(`ğŸ”— Opening NodeNest in new tab: ${FRONTEND_URL}`, 'info');
            window.open(FRONTEND_URL, '_blank');
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ğŸš€ NodeNest Folder Persistence Test Tool Loaded', 'success');
                log('ğŸ’¡ Click "Run All Tests" to diagnose the folder persistence issue', 'info');
            }, 500);
        });
    </script>
</body>
</html>